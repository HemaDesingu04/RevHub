name: Deploy RevHub to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to EC2
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          echo "=== Starting deployment at $(date) ==="
          
          # Navigate to application directory
          cd /home/ec2-user/app
          
          # Clone repository if it doesn't exist
          if [ ! -d "revhub-microservices" ]; then
            echo "Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git revhub-microservices
          fi
          
          cd revhub-microservices
          
          # Pull latest changes
          echo "Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          # Stop existing services
          echo "Stopping existing services..."
          docker-compose down || true
          
          # Build shared modules
          echo "Building shared modules..."
          cd shared
          mvn clean install -DskipTests
          
          # Build all backend services
          echo "Building backend services..."
          cd ../backend-services
          
          services=("api-gateway" "user-service" "post-service" "social-service" "chat-service" "notification-service" "feed-service" "search-service" "saga-orchestrator")
          
          for service in "${services[@]}"; do
            if [ -d "$service" ]; then
              echo "Building $service..."
              cd "$service"
              mvn clean package -DskipTests
              cd ..
            fi
          done
          
          # Start services with Docker
          echo "Starting services with Docker..."
          cd ..
          docker-compose up -d --build
          
          # Wait for services to start
          echo "Waiting for services to start..."
          sleep 120
          
          # Health check with retries
          echo "Performing health checks..."
          max_retries=10
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… API Gateway is healthy!"
              break
            else
              echo "â³ Waiting for API Gateway... (attempt $((retry_count + 1))/$max_retries)"
              sleep 30
              retry_count=$((retry_count + 1))
            fi
          done
          
          if [ $retry_count -eq $max_retries ]; then
            echo "âŒ API Gateway health check failed after $max_retries attempts"
            echo "Container status:"
            docker-compose ps
            echo "API Gateway logs:"
            docker-compose logs --tail=50 api-gateway
            exit 1
          fi
          
          # Check other critical services
          echo "Checking other services..."
          services_to_check=("8081" "8082" "8083" "8084" "8085" "8086" "8087" "8088")
          failed_services=()
          
          for port in "${services_to_check[@]}"; do
            if curl -f "http://localhost:$port/actuator/health" > /dev/null 2>&1; then
              echo "âœ… Service on port $port: HEALTHY"
            else
              echo "âš ï¸ Service on port $port: NOT RESPONDING"
              failed_services+=($port)
            fi
          done
          
          if [ ${#failed_services[@]} -gt 0 ]; then
            echo "âš ï¸ Some services are not responding: ${failed_services[*]}"
            echo "This might be normal if they're still starting up."
          fi
          
          # Show final status
          echo ""
          echo "=== Deployment Summary ==="
          echo "âœ… Deployment completed at $(date)"
          echo "âœ… API Gateway is responding"
          echo "âœ… Docker containers are running"
          echo ""
          echo "Container status:"
          docker-compose ps
          echo ""
          echo "Access your application at:"
          echo "ğŸŒ Frontend: http://${{ secrets.EC2_HOST }}:4200"
          echo "ğŸ”§ API Gateway: http://${{ secrets.EC2_HOST }}:8080"
          echo "ğŸ“Š Consul UI: http://${{ secrets.EC2_HOST }}:8500"
          
        EOF
        
    - name: Deployment Status
      run: |
        echo "ğŸš€ Deployment completed successfully!"
        echo "ğŸ“± Application URL: http://${{ secrets.EC2_HOST }}:4200"
        echo "ğŸ”§ API Gateway: http://${{ secrets.EC2_HOST }}:8080"
        echo "ğŸ“Š Consul UI: http://${{ secrets.EC2_HOST }}:8500"